# Тестовое задание «Интравижн» - Автомат по продаже напитков

## Описание проекта

Веб-приложение эмуляции работы автомата по продаже газированных напитков, реализованное на стеке **ASP.NET Core** и **React/TypeScript**.

## Выполненные обязательные требования

*   **Клиентский фреймворк:** React с использованием функциональных компонентов и хуков.
*   **Язык:** TypeScript. Использование типа `any` полностью отсутствует.
*   **Стейт-менеджмент:** Redux Toolkit (для продуктов, корзины и оплаты).
*   **СУБД:** MS SQL Server (LocalDB). Подход **Code First**.
*   **Паттерны на бэкенде:** Репозиторий и Сервисы.
*   **Фильтрация:** Выполняется на стороне бэкенда (фильтры по бренду и цене).
*   **Пользовательский интерфейс:** Полностью соответствует прототипам из ТЗ (каталог, корзина, оплата).

## Выполненные дополнительные требования

1.  **Импорт Excel-файла:** Реализован полноценный импорт товаров через `.xlsx`/`.xls` файлы с валидацией, шаблоном для скачивания и модальным окном с инструкциями.
2.  **Блокировка автомата:** Реализована система глобальной блокировки на основе сессии. Если один пользователь начинает операцию (добавление в корзину, оплата), второму пользователю показывается страница `/busy` с сообщением о занятости. Для API-запросов возвращается HTTP-статус `423 (Locked)`. Реализовано через кастомные Middleware (`GlobalLockMiddleware`, `ActivityTrackerMiddleware`) и сервис блокировки (`ILockService`).

## Технологии и библиотеки

### Бэкенд (ASP.NET Core)
*   **Framework:** ASP.NET Core
*   **ORM:** Entity Framework Core (Code First)
*   **База данных:** MS SQL Server (LocalDB)
*   **Библиотеки:** `Microsoft.EntityFrameworkCore`, `ClosedXML` (для работы с Excel)
*   **Архитектура:** Паттерны Repository и Service Layer, Dependency Injection.

### Фронтенд (React)
*   **Библиотека:** React
*   **Язык:** TypeScript
*   **Стейт-менеджмент:** Redux Toolkit (`@reduxjs/toolkit`), `react-redux`
*   **Маршрутизация:** React Router (`react-router-dom`)
*   **HTTP-клиент:** Axios
*   **Работа с Excel:** `xlsx`
*   **Стилизация:** CSS Modules
*   **Сборка:** Vite

## Структура проекта
TestTask/ (Корень решения)
├── ReactApp.Client/ (Фронтенд - проект Vite)
│ ├── public/ (Статические файлы)
│ │ ├── *rub.png (Изображения монет)
│ │ ├── *-cola.png (Логотипы брендов)
│ │ └── vite.svg
│ ├── src/
│ │ ├── api/
│ │ │ └── api.ts (HTTP-клиент и интерцепторы)
│ │ ├── assets/
│ │ ├── components/ (React-компоненты)
│ │ │ ├── BusyPage.tsx (Страница "Занято")
│ │ │ ├── Cart.tsx & Cart.css (Корзина)
│ │ │ ├── Payment.tsx & Payment.css (Оплата)
│ │ │ └── ProductList.tsx & ProductList.css (Каталог)
│ │ ├── store/ (Redux store)
│ │ │ ├── slices/
│ │ │ │ ├── cartSlice.ts
│ │ │ │ ├── paymentSlice.ts
│ │ │ │ └── productsSlice.ts
│ │ │ └── store.ts
│ │ ├── App.tsx & App.css
│ │ ├── main.tsx
│ │ ├── types.ts (TypeScript-интерфейсы)
│ │ └── index.css
│ ├── index.html
│ ├── package.json
│ ├── vite.config.ts
│ └── eslint.config.js
│
└── ReactApp.Server/ (Бэкенд - ASP.NET Core проект)
├── Controllers/ (API-контроллеры)
│ ├── BusyController.cs (Отдает HTML для /busy)
│ ├── LockController.cs (API для управления блокировкой)
│ ├── OrdersController.cs
│ ├── PaymentController.cs
│ └── ProductsController.cs
├── Data/
│ └── ApplicationDbContext.cs (Контекст БД)
├── Models/ (EF Core сущности)
│ ├── Brand.cs
│ ├── Coin.cs
│ ├── Order.cs
│ ├── OrderItem.cs
│ └── Product.cs
├── Repositories/
│ ├── Interfaces/ (Интерфейсы репозиториев)
│ │ ├── ICoinRepository.cs
│ │ ├── IOrderRepository.cs
│ │ └── IProductRepository.cs
│ └── Implementations/ (Реализации репозиториев)
│ ├── CoinRepository.cs
│ ├── OrderRepository.cs
│ └── ProductRepository.cs
├── Services/
│ ├── Interfaces/ (Интерфейсы сервисов)
│ │ ├── IExcelImportService.cs
│ │ ├── ILockService.cs
│ │ ├── IProductService.cs
│ │ └── IVendingMachineService.cs
│ └── Implementations/ (Реализации сервисов)
│ ├── ExcelImportService.cs
│ ├── LockService.cs
│ ├── ProductService.cs
│ └── VendingMachineService.cs
├── Middleware/ (Кастомные middleware)
│ ├── ActivityTrackerMiddleware.cs (Обновляет время активности)
│ └── GlobalLockMiddleware.cs (Проверяет и устанавливает блокировку)
├── appsettings.json
├── Program.cs
└── ReactApp.Server.http (Файл для тестирования API)


## Функциональность

### 1. Каталог напитков (`/`)
*   Отображение товаров в адаптивной сетке (4/2/1 в зависимости от ширины экрана).
*   Фильтрация по бренду (через выпадающий список) и максимальной цене (через ползунок).
*   Кнопка "Выбрать" добавляет товар в корзину. Меняет состояние на "Выбрано" и блокируется, если товар закончился.
*   Счетчик "Выбрано" отображает общее количество товаров в корзине и ведет на страницу корзины.
*   Кнопка "Импорт" открывает модальное окно с инструкцией и позволяет загрузить Excel-файл для добавления товаров.

### 2. Корзина (`/cart`)
*   Отображение списка выбранных товаров с изображением бренда, названием, ценой.
*   Изменение количества товаров (кнопки +/-, ручной ввод). Нельзя установить количество < 1 или > чем есть в наличии.
*   Удаление товара из корзины.
*   Расчет и отображение итоговой суммы.
*   Кнопка "Оплата" создает заказ и перенаправляет на страницу оплаты.

### 3. Оплата (`/payment/:orderId`)
*   Внесение денег: для каждого номинала монеты (1, 2, 5, 10 руб.) есть управление количеством.
*   Отображение итоговой суммы к оплате, внесенной суммы (меняет цвет) и суммы сдачи.
*   Кнопка "Оплатить" активна только при внесении достаточной суммы.
*   После успешной оплаты отображается сообщение с благодарностью и подробная информация о выданной сдачи (номиналы и количество монет).
*   Обработка ошибки, если в автомате недостаточно монет для выдачи сдачи.

### 4. Система блокировки
*   При первом посещении пользователю выдается cookie `SessionId`.
*   При начале модифицирующих операций (работа с корзиной, оплата) сессия пользователя захватывает глобальную блокировку.
*   Другие пользователи не могут начать аналогичные операции и видят страницу `/busy` или получают ошибку 423.
*   Блокировка автоматически снимается после 5 минут неактивности или принудительно через кнопку "Экстренное освобождение" на странице занятости (реализовано через endpoint `/api/lock/release`).

## База данных

Спроектирована с использованием Code First. Включает следующие таблицы:
*   `Brands` - Справочник брендов (id, name).
*   `Products` - Каталог товаров (id, name, price, quantity, brandId).
*   `Orders` - Заголовки заказов (id, orderDate, totalAmount).
*   `OrderItems` - Состав заказов (id, orderId, productId, productName, brandName, unitPrice, quantity). *Данные в заказе фиксируются на момент его создания и не меняются при изменении товара.*
*   `Coins` - Монеты в автомате (id, value, quantity).

## Запуск проекта

### Предварительные условия
*   Node.js (v16 или выше)
*   .NET 7.0 SDK (или выше)
*   MS SQL Server (LocalDB обычно устанавливается с Visual Studio)

### Инструкции по запуску
1.  **Откройте решение** `TestTask.sln` в Visual Studio.
2.  **Настройка базы данных:**
    *   Убедитесь, что строка подключения в `ApplicationDbContext.cs` ведет на вашу БД (`Server=(localdb)\\MSSQLLocalDB...`).
    *   В **Консоли диспетчера пакетов (PMC)** выполните команды для создания и применения миграций:
        ```bash
        Add-Migration InitialCreate
        Update-Database
        ```
3.  **Запустите серверный проект:**
    *   Установите `ReactApp.Server` как запускаемый проект.
    *   Запустите проект (F5 или Ctrl+F5). Сервер запустится на `http://localhost:5006`.
4.  **Запустите клиентский проект:**
    *   Откройте терминал и перейдите в папку `ReactApp.Client`.
    *   Установите зависимости и запустите dev-сервер:
        ```bash
        cd ReactApp.Client
        npm install
        npm run dev
        ```
    *   Клиент запустится на `http://localhost:3000`.
5.  **Откройте браузер и перейдите по адресу клиента (`http://localhost:3000`).**

## Важные заметки

*   **Изображения:** Убедитесь, что в папке `public` находятся все необходимые изображения монет (`1rub.png`, `2rub.png`, etc.) и брендов. Их пути жестко прописаны в компонентах.
*   **CORS:** Настройки CORS между клиентом (порт 3000) и сервером (порт 5006) должны быть корректно настроены в `Program.cs` серверного проекта.
*   **Локальная БД:** Строка подключения по умолчанию использует LocalDB. Убедитесь, что он установлен и запущен.